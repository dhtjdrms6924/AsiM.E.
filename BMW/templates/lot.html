<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lot.name }} 도면 및 예약</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .parking-map-container {
            position: relative;
            width: 100%;
            height: auto;
            padding-bottom: 58.29%;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            background-color: #f5f5f5;
        }
        .parking-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .spot-area {
            position: absolute;
            display: flex; /* Flexbox 추가 */
            flex-direction: column; /* 세로 정렬 */
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 128, 0, 0.4);
            border: 2px solid green;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center; /* 텍스트 가운데 정렬 */
            line-height: 1.2; /* 줄 높이 조정 */
        }
        .spot-area:hover {
            box-shadow: 0 0 10px rgba(0, 128, 0, 0.6);
            transform: scale(1.05);
        }
        .spot-area.spot-occupied {
            background-color: rgba(255, 0, 0, 0.4);
            border: 2px solid red;
            cursor: pointer; /* disabled 제거로 커서 변경 */
        }
        .spot-area-label {
            color: #fff;
            font-size: 0.75rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            line-height: 1;
        }
        .spot-points-label {
            background-color: #f59e0b; /* 노란색 */
            color: #fff;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            line-height: 1;
            margin-top: 4px; /* 라벨 간 간격 추가 */
        }
        .reservation-form-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .reservation-form-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }
        .flash-message-container {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: fadeInOut 5s forwards;
        }
        .flash-message {
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            text-align: center;
        }
        .flash-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .flash-success {
            background-color: #dcfce7;
            color: #15803d;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        /* 최종 타임라인 CSS */
        .timeline-wrapper {
            position: relative;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 1rem;
            -webkit-overflow-scrolling: touch;
        }
        .timeline-container {
            display: flex;
            width: max-content;
            padding-top: 2rem;
            position: relative;
        }
        .timeline-slot {
            width: 50px;
            flex-shrink: 0;
            height: 40px;
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .timeline-slot:first-child {
            border-left: 1px solid #e5e7eb;
        }
        .timeline-slot:last-child {
            border-right: none;
        }
        
        /* 시간 눈금 스타일 */
        .timeline-slot.has-hour::before {
            content: attr(data-time);
            position: absolute;
            top: -1.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }
        .timeline-slot.has-hour::after {
            content: '';
            position: absolute;
            top: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 0.5rem;
            background-color: #6b7280;
        }
        
        /* 상태별 색상 */
        .timeline-slot.status-past {
            background-color: #e5e7eb; /* 지난 시간: 회색 */
            cursor: not-allowed;
        }
        .timeline-slot.status-reserved {
            background-color: #4b5563; /* 이미 예약됨: 진한 회색 */
            cursor: not-allowed;
        }
        .timeline-slot.status-selected-start {
            background-color: #fcd34d; /* 선택 시작: 노란색 */
        }
        .timeline-slot.status-selected-range {
            background-color: #fde68a; /* 선택 구간: 연한 노란색 */
        }
        .timeline-slot.status-selected-end {
            background-color: #fcd34d; /* 선택 종료: 노란색 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">{{ lot.name }}</h1>
            <a href="{{ url_for('search_location') }}" class="text-blue-600 hover:underline">← 주차장 목록으로</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-message-container">
                {% for category, message in messages %}
                    <div class="flash-message {% if category == 'error' %}flash-error{% elif category == 'success' %}flash-success{% endif %}">
                        {{ message|safe }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-2/3">
                <div class="parking-map-container">
                    <img src="{{ lot.image }}" alt="{{ lot.name }} 도면" class="parking-map">
                    
                    {% for spot in spots_data %}
                    <button class="{{ spot.display_class }}"
                        data-spot-id="{{ spot.id }}"
                        data-original-coords="{{ spot.coords }}"
                        data-spot-points="{{ spot.estimated_points }}"
                        onclick="selectSpotForReservation(this, {{ spot.id }})">
                        <span class="spot-area-label">{{ spot.id }}</span>
                        <span class="spot-points-label">포인트<br>{{ spot.estimated_points }}</span>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="lg:w-1/3">
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold mb-4">주차장 정보</h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li><strong>분당 요금:</strong> {{ lot.base_price_per_min }}원</li>
                        <li><strong>교통량:</strong> {{ lot.traffic_level }} (1:한산 ~ 5:혼잡)</li>
                        <li><strong>예상 적립 포인트 (1시간):</strong> {{ calculate_eco_points(lot_id, 0, 60) }}점</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="reservationModal" class="reservation-form-container">
        <div class="reservation-form-card">
            <h2 class="text-2xl font-bold mb-4">주차 공간 <span id="selectedSpotId"></span> 예약</h2>
            <button class="close-button" onclick="hideReservationForm()">&times;</button>
            
            <p id="timelineMessage" class="text-center text-sm text-gray-500 mb-2">원하는 시간대를 선택해주세요.</p>

            <div class="timeline-wrapper">
                <div class="timeline-container"></div>
            </div>

            <form id="reserveForm" action="" method="post" class="space-y-4 mt-4">
                <input type="hidden" name="spot_id" id="formSpotId">
                <input type="hidden" name="date" value="{{ current_dt|datetimeformat_date }}">
                <input type="hidden" name="hour" id="formHour">
                <input type="hidden" name="minute" id="formMinute">
                <input type="hidden" name="duration_min" id="formDuration">
                
                <div class="text-sm text-gray-500 mb-4">
                    예상 요금: <span id="expectedPrice">0</span>원 | 예상 적립 포인트: <span id="expectedPoints">0</span>점
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-200">예약 및 결제</button>
            </form>
        </div>
    </div>
    
    <script>
        const reservationModal = document.getElementById('reservationModal');
        const reserveForm = document.getElementById('reserveForm');
        const selectedSpotIdSpan = document.getElementById('selectedSpotId');
        const formSpotIdInput = document.getElementById('formSpotId');
        const expectedPriceSpan = document.getElementById('expectedPrice');
        const expectedPointsSpan = document.getElementById('expectedPoints');
        const timelineWrapper = document.querySelector('.timeline-wrapper');
        const timelineContainer = document.querySelector('.timeline-container');
        const timelineMessage = document.getElementById('timelineMessage');

        let selectedSpotId = null;
        let selectedStartSlot = null;
        let selectedEndSlot = null;
        let today = '{{ current_dt|datetimeformat_date }}';

        document.addEventListener('DOMContentLoaded', () => {
            const flashMessage = document.querySelector('.flash-message-container');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.style.opacity = '0';
                    flashMessage.style.transition = 'opacity 1s ease-out';
                    setTimeout(() => {
                        flashMessage.style.display = 'none';
                    }, 1000);
                }, 4000);
            }
            
            const mapImage = document.querySelector('.parking-map');
            if (mapImage.complete) {
                resizeMap();
            } else {
                mapImage.onload = resizeMap;
            }
        });

        window.addEventListener('resize', resizeMap);
        
        function resizeMap() {
            const mapImage = document.querySelector('.parking-map');
            const spotAreas = document.querySelectorAll('.spot-area');
            const originalWidth = mapImage.naturalWidth;
            const originalHeight = mapImage.naturalHeight;
            const displayedWidth = mapImage.clientWidth;
            const displayedHeight = mapImage.clientHeight;
            const widthRatio = displayedWidth / originalWidth;
            const heightRatio = displayedHeight / originalHeight;

            spotAreas.forEach(area => {
                const originalCoordsStr = area.dataset.originalCoords;
                if (!originalCoordsStr) return;
                const [x1, y1, x2, y2] = originalCoordsStr.split(',').map(Number);
                const newLeft = Math.round(x1 * widthRatio);
                const newTop = Math.round(y1 * heightRatio);
                const newWidth = Math.round((x2 - x1) * widthRatio);
                const newHeight = Math.round((y2 - y1) * heightRatio);
                area.style.left = `${newLeft}px`;
                area.style.top = `${newTop}px`;
                area.style.width = `${newWidth}px`;
                area.style.height = `${newHeight}px`;
            });
        }
        
        function selectSpotForReservation(element, spotId) {
            hideReservationForm();
            selectedSpotId = spotId;
            selectedStartSlot = null;
            selectedEndSlot = null;
            
            selectedSpotIdSpan.textContent = spotId;
            formSpotIdInput.value = spotId;
            reserveForm.action = `/reserve/{{ lot_id }}/${spotId}`;
            reservationModal.style.display = 'flex';
            timelineMessage.textContent = '원하는 시간대를 선택해주세요.';
            updateEstimates();
            fetchReservationTimeline(spotId);
        }

        function hideReservationForm() {
            reservationModal.style.display = 'none';
        }
        
        function updateEstimates() {
            const spotId = formSpotIdInput.value;
            let durationMin = 0;
            if (selectedStartSlot && selectedEndSlot) {
                const startTimestamp = parseInt(selectedStartSlot.dataset.timestamp);
                const endTimestamp = parseInt(selectedEndSlot.dataset.timestamp) + (30 * 60 * 1000);
                durationMin = (endTimestamp - startTimestamp) / (60 * 1000);
                
                document.getElementById('formHour').value = selectedStartSlot.dataset.hour;
                document.getElementById('formMinute').value = selectedStartSlot.dataset.minute;
                document.getElementById('formDuration').value = durationMin;
                
            } else if (selectedStartSlot && !selectedEndSlot) {
                const startTimestamp = parseInt(selectedStartSlot.dataset.timestamp);
                durationMin = 30;

                document.getElementById('formHour').value = selectedStartSlot.dataset.hour;
                document.getElementById('formMinute').value = selectedStartSlot.dataset.minute;
                document.getElementById('formDuration').value = durationMin;

                fetch(`/calculate_estimates/{{ lot_id }}/${spotId}/${durationMin}`)
                    .then(response => response.json())
                    .then(data => {
                        expectedPriceSpan.textContent = data.price;
                        expectedPointsSpan.textContent = data.points;
                    });
                return;

            } else {
                expectedPriceSpan.textContent = '0';
                expectedPointsSpan.textContent = '0';
                return;
            }

            if (spotId && durationMin) {
                fetch(`/calculate_estimates/{{ lot_id }}/${spotId}/${durationMin}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('네트워크 응답이 올바르지 않습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        expectedPriceSpan.textContent = data.price;
                        expectedPointsSpan.textContent = data.points;
                    })
                    .catch(error => {
                        console.error('예상 요금/포인트 정보를 가져오는 중 오류 발생:', error);
                        expectedPriceSpan.textContent = '정보 없음';
                        expectedPointsSpan.textContent = '정보 없음';
                    });
            }
        }
        
        function fetchReservationTimeline(spotId) {
            timelineContainer.innerHTML = '';
            
            const now = new Date();
            const totalSlots = 48; // 24시간 * 2 (30분 단위)
            
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0);
            let currentSlotIndex = -1;

            for (let i = 0; i < totalSlots; i++) {
                const slotTime = new Date(startOfToday.getTime() + (i * 30 * 60 * 1000));
                
                const slot = document.createElement('div');
                slot.className = 'timeline-slot';
                slot.dataset.timestamp = slotTime.getTime();
                slot.dataset.hour = slotTime.getHours();
                slot.dataset.minute = slotTime.getMinutes();

                if (slotTime.getMinutes() === 0) {
                    slot.classList.add('has-hour');
                    const hour = String(slotTime.getHours()).padStart(2, '0');
                    const minute = String(slotTime.getMinutes()).padStart(2, '0');
                    slot.dataset.time = `${hour}:${minute}`;
                }

                if (slotTime.getTime() < now.getTime()) {
                    slot.classList.add('status-past');
                }
                
                if (currentSlotIndex === -1 && slotTime.getTime() >= now.getTime()) {
                    currentSlotIndex = i;
                }
                
                timelineContainer.appendChild(slot);
            }
            
            fetch(`/reservation_status/{{ lot_id }}/${spotId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답이 올바르지 않습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    const slots = timelineContainer.querySelectorAll('.timeline-slot');
                    
                    slots.forEach(slot => {
                        const slotTimestamp = parseInt(slot.dataset.timestamp);
                        let isReserved = false;
                        data.reservations.forEach(reservation => {
                            if (slotTimestamp >= reservation.start * 1000 && slotTimestamp < reservation.end * 1000) {
                                isReserved = true;
                            }
                        });
                        
                        if (isReserved) {
                            slot.classList.add('status-reserved');
                            slot.classList.remove('status-past');
                        }
                    });
                    
                    addTimelineEventListeners();

                    // 현재 시간 슬롯으로 스크롤
                    if (currentSlotIndex !== -1) {
                        const slotWidth = slots[0].offsetWidth;
                        timelineWrapper.scrollLeft = currentSlotIndex * slotWidth - (timelineWrapper.offsetWidth / 2);
                    }
                })
                .catch(error => {
                    console.error('예약 상태 정보를 가져오는 중 오류 발생:', error);
                    timelineMessage.textContent = '예약 정보를 불러오지 못했습니다.';
                    const slots = timelineContainer.querySelectorAll('.timeline-slot');
                    slots.forEach(slot => {
                        slot.classList.add('status-past');
                    });
                });
        }
        
        function addTimelineEventListeners() {
            const slots = timelineContainer.querySelectorAll('.timeline-slot');
            slots.forEach(slot => {
                slot.addEventListener('click', () => {
                    if (slot.classList.contains('status-past') || slot.classList.contains('status-reserved')) {
                        timelineMessage.textContent = '선택 불가능한 시간입니다.';
                        return;
                    }

                    // 선택 상태 초기화
                    if (selectedStartSlot && selectedStartSlot !== slot) {
                        if (parseInt(slot.dataset.timestamp) < parseInt(selectedStartSlot.dataset.timestamp)) {
                            // 현재 클릭한 슬롯이 시작 슬롯보다 이전 시간일 경우
                            selectedEndSlot = selectedStartSlot;
                            selectedStartSlot = slot;
                        } else {
                            selectedEndSlot = slot;
                        }
                    } else if (selectedStartSlot === slot && selectedEndSlot) {
                        // 이미 시작, 종료 슬롯이 선택된 상태에서 시작 슬롯을 다시 클릭하면 선택 취소
                        selectedStartSlot = null;
                        selectedEndSlot = null;
                        timelineMessage.textContent = '원하는 시간대를 선택해주세요.';
                    } else if (selectedStartSlot === slot) {
                        // 시작 슬롯만 선택된 상태에서 다시 클릭하면 30분 예약 확정
                        selectedEndSlot = slot;
                        timelineMessage.textContent = '30분 예약이 선택되었습니다.';
                    } else {
                        // 첫 클릭
                        selectedStartSlot = slot;
                        selectedEndSlot = null;
                        timelineMessage.textContent = '종료 시간을 선택하세요.';
                    }


                    slots.forEach(s => s.classList.remove('status-selected-start', 'status-selected-end', 'status-selected-range'));
                    
                    if (selectedStartSlot && selectedEndSlot) {
                        const startTS = parseInt(selectedStartSlot.dataset.timestamp);
                        const endTS = parseInt(selectedEndSlot.dataset.timestamp);
                        const rangeStart = Math.min(startTS, endTS);
                        const rangeEnd = Math.max(startTS, endTS);

                        slots.forEach(s => {
                            const currentTS = parseInt(s.dataset.timestamp);
                            if (currentTS >= rangeStart && currentTS <= rangeEnd) {
                                s.classList.add('status-selected-range');
                            }
                        });
                        selectedStartSlot.classList.add('status-selected-start');
                        selectedEndSlot.classList.add('status-selected-end');

                    } else if (selectedStartSlot) {
                        selectedStartSlot.classList.add('status-selected-start');
                    }

                    updateEstimates();
                });
            });
        }
        
        reserveForm.addEventListener('submit', (e) => {
            if (!selectedStartSlot) {
                e.preventDefault();
                alert('시간을 선택해주세요.');
            } else if (!selectedEndSlot) {
                e.preventDefault();
                alert('종료 시간을 선택하거나 30분 예약을 위해 한 번 더 클릭해주세요.');
            }
        });
    </script>
</body>
</html>