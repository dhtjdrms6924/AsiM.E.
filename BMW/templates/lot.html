<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lot.name }} 도면 및 예약</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .parking-map-container {
            position: relative;
            width: 100%;
            height: auto;
            /* 원본 이미지 비율에 맞게 padding-bottom 조정 */
            padding-bottom: 58.29%;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            background-color: #f5f5f5;
        }
        .parking-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .spot-area {
            position: absolute;
            background-color: rgba(0, 128, 0, 0.4);
            border: 2px solid green;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .spot-area:hover {
            box-shadow: 0 0 10px rgba(0, 128, 0, 0.6);
            transform: scale(1.05);
        }
        .spot-area.status-occupied {
            background-color: rgba(255, 0, 0, 0.4);
            border: 2px solid red;
            cursor: not-allowed;
        }
        .spot-area-label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            color: #fff;
            font-size: 0.75rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .reservation-form-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .reservation-form-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }
        .flash-message-container {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: fadeInOut 5s forwards;
        }
        .flash-message {
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            text-align: center;
        }
        .flash-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .flash-success {
            background-color: #dcfce7;
            color: #15803d;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        /* 최종 타임라인 CSS */
        .timeline-wrapper {
            position: relative;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 1rem;
            -webkit-overflow-scrolling: touch;
        }
        .timeline-container {
            display: flex;
            width: max-content;
            padding-top: 2rem;
            position: relative;
        }
        .timeline-slot {
            width: 50px;
            flex-shrink: 0;
            height: 40px;
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .timeline-slot:first-child {
            border-left: 1px solid #e5e7eb;
        }
        .timeline-slot:last-child {
            border-right: none;
        }
        
        /* 시간 눈금 스타일 */
        .timeline-slot.has-hour::before {
            content: attr(data-time);
            position: absolute;
            top: -1.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }
        .timeline-slot.has-hour::after {
            content: '';
            position: absolute;
            top: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 0.5rem;
            background-color: #6b7280;
        }
        
        /* 상태별 색상 */
        .timeline-slot.status-past {
            background-color: #e5e7eb; /* 지난 시간: 회색 */
            cursor: not-allowed;
        }
        .timeline-slot.status-reserved {
            background-color: #4b5563; /* 이미 예약됨: 진한 회색 */
            cursor: not-allowed;
        }
        .timeline-slot.status-selected {
            background-color: #fcd34d; /* 선택됨: 노란색 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">{{ lot.name }}</h1>
            <a href="{{ url_for('search_location') }}" class="text-blue-600 hover:underline">← 주차장 목록으로</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-message-container">
                {% for category, message in messages %}
                    <div class="flash-message {% if category == 'error' %}flash-error{% elif category == 'success' %}flash-success{% endif %}">
                        {{ message|safe }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-2/3">
                <div class="parking-map-container">
                    <img src="{{ lot.image }}" alt="{{ lot.name }} 도면" class="parking-map">
                    
                    {% for spot in spots_data %}
                    <button class="spot-area {{ spot.display_class }}"
                        data-spot-id="{{ spot.id }}"
                        data-original-coords="{{ spot.coords }}"
                        {% if spot.display_class == 'spot-unavailable' %}disabled{% endif %}
                        onclick="showReservationForm(this, {{ spot.id }})">
                        <span class="spot-area-label">{{ spot.id }}</span>
                    </button>
                    
                    {% endfor %}
                </div>
            </div>

            <div class="lg:w-1/3">
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold mb-4">주차장 정보</h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li><strong>분당 요금:</strong> {{ lot.base_price_per_min }}원</li>
                        <li><strong>교통량:</strong> {{ lot.traffic_level }} (1:한산 ~ 5:혼잡)</li>
                        <li><strong>예상 적립 포인트 (1시간):</strong> {{ calculate_eco_points(lot_id, 0, 60) }}점</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="reservationModal" class="reservation-form-container">
        <div class="reservation-form-card">
            <h2 class="text-2xl font-bold mb-4">주차 공간 <span id="selectedSpotId"></span> 예약</h2>
            <button class="close-button" onclick="hideReservationForm()">&times;</button>
            
            <p id="timelineMessage" class="text-center text-sm text-gray-500 mb-2">원하는 시간대를 선택해주세요.</p>

            <div class="timeline-wrapper">
                <div class="timeline-container"></div>
            </div>

            <form id="reserveForm" action="/reserve/{{ lot_id }}/0" method="post" class="space-y-4 mt-4">
                <input type="hidden" name="spot_id" id="formSpotId">
                <input type="hidden" name="date" value="{{ current_dt|datetimeformat_date }}">

                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="hour" class="block text-sm font-medium text-gray-700">시작 시간</label>
                        <select name="hour" id="hour" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            {% for h in range(0, 24) %}
                            <option value="{{ h }}" {% if h == current_dt.hour %}selected{% endif %}>{{ "%02d"|format(h) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="minute" class="block text-sm font-medium text-gray-700">시작 분</label>
                        <select name="minute" id="minute" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <option value="0" {% if current_dt.minute < 30 %}selected{% endif %}>00</option>
                            <option value="30" {% if current_dt.minute >= 30 %}selected{% endif %}>30</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="duration_min" class="block text-sm font-medium text-gray-700">이용 시간 (분)</label>
                    <input type="number" name="duration_min" id="duration_min" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" min="30" step="30" value="60">
                </div>

                <div class="text-sm text-gray-500 mb-4">
                    예상 요금: <span id="expectedPrice">0</span>원 | 예상 적립 포인트: <span id="expectedPoints">0</span>점
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-200">예약 및 결제</button>
            </form>
        </div>
    </div>
    
    <script>
        const reservationModal = document.getElementById('reservationModal');
        const reserveForm = document.getElementById('reserveForm');
        const selectedSpotIdSpan = document.getElementById('selectedSpotId');
        const formSpotIdInput = document.getElementById('formSpotId');
        const expectedPriceSpan = document.getElementById('expectedPrice');
        const expectedPointsSpan = document.getElementById('expectedPoints');
        const timelineWrapper = document.querySelector('.timeline-wrapper');
        const timelineContainer = document.querySelector('.timeline-container');
        let selectedSlot = null;
        let today = '{{ current_dt|datetimeformat_date }}';

        document.addEventListener('DOMContentLoaded', () => {
            // 기존 플래시 메시지 코드
            const flashMessage = document.querySelector('.flash-message-container');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.style.opacity = '0';
                    flashMessage.style.transition = 'opacity 1s ease-out';
                    setTimeout(() => {
                        flashMessage.style.display = 'none';
                    }, 1000);
                }, 4000);
            }
            
            // 페이지가 로드되고 리소스가 준비되면 지도를 조정
            const mapImage = document.querySelector('.parking-map');
            if (mapImage.complete) {
                resizeMap();
            } else {
                mapImage.onload = resizeMap;
            }
        });

        // 브라우저 창 크기 변경 시 지도를 다시 조정
        window.addEventListener('resize', resizeMap);
        
        // 주차 공간 버튼의 위치와 크기를 동적으로 조정하는 함수
        function resizeMap() {
            const mapImage = document.querySelector('.parking-map');
            const spotAreas = document.querySelectorAll('.spot-area');
        
            // 원본 이미지의 너비와 높이를 이미지 엘리먼트 자체에서 가져옵니다.
            // 이렇게 하면 어떤 이미지 파일이 사용되더라도 코드를 수정할 필요가 없습니다.
            const originalWidth = mapImage.naturalWidth;
            const originalHeight = mapImage.naturalHeight;

            const displayedWidth = mapImage.clientWidth;
            const displayedHeight = mapImage.clientHeight;

            // 현재 표시된 이미지와 원본 이미지 간의 비율을 계산
            const widthRatio = displayedWidth / originalWidth;
            const heightRatio = displayedHeight / originalHeight;

            spotAreas.forEach(area => {
                const originalCoordsStr = area.dataset.originalCoords;
                if (!originalCoordsStr) return;

                const [x1, y1, x2, y2] = originalCoordsStr.split(',').map(Number);
            
                // 새로운 좌표 계산
                const newLeft = Math.round(x1 * widthRatio);
                const newTop = Math.round(y1 * heightRatio);
                const newWidth = Math.round((x2 - x1) * widthRatio);
                const newHeight = Math.round((y2 - y1) * heightRatio);

                // 계산된 스타일 적용
                area.style.left = `${newLeft}px`;
                area.style.top = `${newTop}px`;
                area.style.width = `${newWidth}px`;
                area.style.height = `${newHeight}px`;
            });
        }
        
        function showReservationForm(element, spotId) {
            hideReservationForm();
            selectedSpotIdSpan.textContent = spotId;
            formSpotIdInput.value = spotId;
            reserveForm.action = `/reserve/{{ lot_id }}/${spotId}`;
            reservationModal.style.display = 'flex';
            fetchReservationTimeline(spotId);
            updateEstimates();
        }

        function hideReservationForm() {
            reservationModal.style.display = 'none';
        }

        // 예상 요금 및 포인트 정보를 비동기로 가져오는 함수 (오류 처리 추가)
        function updateEstimates() {
            const spotId = formSpotIdInput.value;
            const durationMin = document.getElementById('duration_min').value;
            if (spotId && durationMin) {
                fetch(`/calculate_estimates/{{ lot_id }}/${spotId}/${durationMin}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('네트워크 응답이 올바르지 않습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        expectedPriceSpan.textContent = data.price;
                        expectedPointsSpan.textContent = data.points;
                    })
                    .catch(error => {
                        console.error('예상 요금/포인트 정보를 가져오는 중 오류 발생:', error);
                        expectedPriceSpan.textContent = '정보 없음';
                        expectedPointsSpan.textContent = '정보 없음';
                    });
            }
        }
        
        document.getElementById('duration_min').addEventListener('change', updateEstimates);
        document.getElementById('hour').addEventListener('change', updateEstimates);
        document.getElementById('minute').addEventListener('change', updateEstimates);

        // 주차장 예약 타임라인을 비동기로 가져오는 함수 (오류 처리 추가)
        function fetchReservationTimeline(spotId) {
            timelineContainer.innerHTML = '';
            
            const now = new Date();
            const roundedNow = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), Math.floor(now.getMinutes() / 30) * 30);
            
            const totalSlots = 48; // 24시간 * 2 (30분 단위)
            
            for (let i = 0; i < totalSlots; i++) {
                const slotTime = new Date(roundedNow.getTime() + (i * 30 * 60 * 1000));
                
                const slot = document.createElement('div');
                slot.className = 'timeline-slot';
                slot.dataset.timestamp = slotTime.getTime();
                slot.dataset.hour = slotTime.getHours();
                slot.dataset.minute = slotTime.getMinutes();

                // 시간 눈금 표시
                if (slotTime.getMinutes() === 0) {
                    slot.classList.add('has-hour');
                    const hour = String(slotTime.getHours()).padStart(2, '0');
                    const minute = String(slotTime.getMinutes()).padStart(2, '0');
                    slot.dataset.time = `${hour}:${minute}`;
                }

                // 지난 시간 슬롯 비활성화
                if (slotTime.getTime() < now.getTime()) {
                    slot.classList.add('status-past');
                }
                
                timelineContainer.appendChild(slot);
            }
            
            fetch(`/reservation_status/{{ lot_id }}/${spotId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답이 올바르지 않습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    const slots = timelineContainer.querySelectorAll('.timeline-slot');
                    
                    slots.forEach(slot => {
                        const slotTimestamp = parseInt(slot.dataset.timestamp);
                        
                        let isReserved = false;
                        data.reservations.forEach(reservation => {
                            if (slotTimestamp >= reservation.start * 1000 && slotTimestamp < reservation.end * 1000) {
                                isReserved = true;
                            }
                        });
                        
                        if (isReserved) {
                            slot.classList.add('status-reserved');
                            slot.classList.remove('status-past'); // 예약된 시간은 과거 시간보다 우선
                        }
                    });
                    
                    addTimelineEventListeners();
                })
                .catch(error => {
                    console.error('예약 상태 정보를 가져오는 중 오류 발생:', error);
                    document.getElementById('timelineMessage').textContent = '예약 정보를 불러오지 못했습니다.';
                    // 오류 발생 시 타임라인 슬롯 클릭 비활성화
                    const slots = timelineContainer.querySelectorAll('.timeline-slot');
                    slots.forEach(slot => {
                        slot.classList.add('status-past');
                        slot.classList.remove('status-selected');
                        selectedSlot = null;
                    });
                });
        }
        
        function addTimelineEventListeners() {
            const slots = timelineContainer.querySelectorAll('.timeline-slot');
            slots.forEach(slot => {
                slot.addEventListener('click', () => {
                    if (slot.classList.contains('status-past') || slot.classList.contains('status-reserved')) {
                        document.getElementById('timelineMessage').textContent = '선택 불가능한 시간입니다.';
                        return;
                    }

                    if (selectedSlot) {
                        selectedSlot.classList.remove('status-selected');
                    }
                    
                    slot.classList.add('status-selected');
                    selectedSlot = slot;
                    
                    const selectedDate = today;
                    const selectedHour = String(slot.dataset.hour).padStart(2, '0');
                    const selectedMinute = String(slot.dataset.minute).padStart(2, '0');
                    
                    document.getElementById('hour').value = slot.dataset.hour;
                    document.getElementById('minute').value = slot.dataset.minute;
                    
                    document.getElementById('timelineMessage').textContent = `${selectedDate} ${selectedHour}시 ${selectedMinute}분 선택됨`;
                    updateEstimates();
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const flashMessage = document.querySelector('.flash-message-container');
            if (flashMessage) {
                setTimeout(() => {
                    flashMessage.style.opacity = '0';
                    flashMessage.style.transition = 'opacity 1s ease-out';
                    setTimeout(() => {
                        flashMessage.style.display = 'none';
                    }, 1000);
                }, 4000);
            }
        });
    </script>
</body>
</html>
